<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bar Stock Counter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-tertiary: #374151;
            --text-primary: #d1d5db;
            --text-secondary: #9ca3af;
            --border-color: #4b5563;
            --accent-color: #22c55e;
            --accent-hover: #16a34a;
            --table-highlight: #047857;
            --table-highlight-faint: #065f46;
        }

        [data-theme="light"] {
            --bg-primary: #f3f4f6;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f3f4f6; /* Changed for better contrast */
            --text-primary: #1f2937;
            --text-secondary: #4b5563;
            --border-color: #d1d5db;
            --accent-color: #166534;
            --accent-hover: #15803d;
            --table-highlight: #a7f3d0;
            --table-highlight-faint: #d1fae5;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }
        .loader {
            border: 4px solid var(--bg-tertiary);
            border-top: 4px solid var(--accent-color);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .summary-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            overflow-x: auto;
            display: block;
        }
        .summary-table th, .summary-table td {
            border: 1px solid var(--border-color);
            padding: 8px;
            text-align: left;
            white-space: nowrap;
        }
        .summary-table th {
            background-color: var(--bg-secondary);
            font-weight: 600;
        }
        .summary-table td:not(:first-child) {
            text-align: center;
        }
        .summary-table tr:nth-child(even) {
            background-color: var(--bg-tertiary);
        }
        #login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .dragging {
            opacity: 0.5;
            background: var(--bg-tertiary);
        }
        .handle {
            cursor: grab;
        }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="p-8 rounded-lg shadow-xl text-center w-full max-w-sm border" style="background-color: var(--bg-secondary); border-color: var(--border-color);">
            <h2 class="text-xl font-bold mb-4" style="color: var(--text-primary);">Line Check Login</h2>
            <input type="email" id="email-input" class="p-2 border rounded-md w-full mb-2" style="background-color: var(--bg-tertiary); border-color: var(--border-color);" placeholder="Email">
            <input type="password" id="password-input" class="p-2 border rounded-md w-full mb-4" style="background-color: var(--bg-tertiary); border-color: var(--border-color);" placeholder="Password">
            <button id="login-submit" class="text-white px-6 py-2 rounded-md shadow w-full" style="background-color: var(--accent-color);">Login</button>
            <p id="login-error" class="text-red-400 mt-2 text-sm h-4"></p>
        </div>
    </div>

    <div id="app" class="max-w-4xl mx-auto p-4" style="display: none;">
        
        <header class="rounded-lg shadow p-4 mb-6 border" style="background-color: var(--bg-secondary); border-color: var(--border-color);">
            <div class="flex justify-between items-center">
                <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-700">
                    <svg id="theme-icon-dark" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-moon-fill" viewBox="0 0 16 16">
                        <path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/>
                    </svg>
                    <svg id="theme-icon-light" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-sun-fill hidden" viewBox="0 0 16 16">
                        <path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707z"/>
                    </svg>
                </button>
                <h1 class="text-2xl font-bold text-center flex-grow" style="color: var(--text-primary);">Line Check</h1>
                <button id="logout-button" class="bg-red-600 text-white px-3 py-1 rounded-md shadow hover:bg-red-700 text-sm">Logout</button>
            </div>
            <nav id="nav-buttons" class="flex justify-center space-x-2 mt-4">
                <button data-view="input" class="nav-button px-4 py-2 rounded-md shadow">Input</button>
                <button data-view="view" class="nav-button px-4 py-2 rounded-md shadow">View</button>
                <button data-view="configure" class="nav-button px-4 py-2 rounded-md shadow">Configure</button>
            </nav>
        </header>

        <main id="main-content">
            <div id="loading" class="text-center p-8">
                <div class="loader"></div>
                <p>Loading App...</p>
            </div>
        </main>

    </div>

    <template id="input-view-template">
        <div id="input-view" class="space-y-6">
            <div class="p-4 rounded-lg shadow space-y-4 border" style="background-color: var(--bg-secondary); border-color: var(--border-color);">
                <div class="flex items-center space-x-2">
                    <label for="day-selector" class="font-semibold">Select Day:</label>
                    <select id="day-selector" class="p-2 border rounded-md shadow-sm" style="background-color: var(--bg-tertiary); border-color: var(--border-color);"></select>
                </div>
                <hr style="border-color: var(--border-color);"/>
                <div class="flex items-center space-x-2">
                     <label class="font-semibold w-28">Input Mode:</label>
                    <div class="flex rounded-md shadow-sm">
                        <button data-mode="byProduct" class="input-mode-btn px-4 py-2 rounded-l-md border" style="border-color: var(--border-color);">By Product</button>
                        <button data-mode="byRoom" class="input-mode-btn px-4 py-2 rounded-r-md border -ml-px" style="border-color: var(--border-color);">By Room</button>
                    </div>
                </div>
                <div id="selector-container" class="flex items-center space-x-2">
                    <!-- Dropdown will be inserted here -->
                </div>
            </div>
            <div id="product-input-container"></div>
        </div>
    </template>

    <template id="view-view-template">
        <div id="view-view" class="rounded-lg shadow p-6 border" style="background-color: var(--bg-secondary); border-color: var(--border-color);">
            <div id="view-controls" class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4"></div>
            <div id="view-content-container"></div>
        </div>
    </template>

    <template id="configure-view-template">
        <div id="configure-view" class="rounded-lg shadow p-6 border" style="background-color: var(--bg-secondary); border-color: var(--border-color);">
            <h2 class="text-xl font-bold mb-4">Configure Products</h2>
            <div class="flex flex-col sm:flex-row gap-2 mb-6">
                <input type="text" id="new-product-name" class="flex-grow p-2 border rounded-md" style="background-color: var(--bg-tertiary); border-color: var(--border-color);" placeholder="Enter new product name">
                <button id="add-product-btn" class="text-white px-4 py-2 rounded-md shadow" style="background-color: var(--accent-color);">Add Product</button>
            </div>
            <div id="product-list-container">
                <h3 class="font-semibold mb-2">Current Products:</h3>
                <ul id="product-list" class="space-y-2"></ul>
            </div>
        </div>
    </template>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, addDoc, deleteDoc, setDoc, writeBatch, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
             apiKey: "AIzaSyDTTRoipMen2gSn8s602nV_Ao_9MogDUK4",
             authDomain: "linecheck-84928.firebaseapp.com",
             projectId: "linecheck-84928",
             storageBucket: "linecheck-84928.appspot.com",
             messagingSenderId: "348317364563",
             appId: "1:348317364563:web:2d0e8bec52d5323ca0b1a6"
        };

        let db, auth, userId;
        let products = [];
        let counts = {};
        let currentView = 'input';
        let viewPageMode = 'daily';
        let inputMode = 'byProduct';
        let selectedProductId = null;
        let selectedRoomId = null;
        let dataListenersAttached = false;

        const locations = [
            { id: 'islandBar', name: 'Island Bar' },
            { id: 'mainBar', name: 'Main Bar' },
            { id: 'coldRoom', name: 'Cold Room' },
            { id: 'kegRoom', name: 'Keg Room' }
        ];
        const specialProductConfig = {
            "ron santiago 8yo": [
                { id: 'pergolaKilner', name: 'Pergola Punch Batch Kilner' },
                { id: 'pergolaBtl', name: 'Pergola Punch Batch BTL' },
                { id: 'strawberrySlushie', name: 'Strawberry Daquiri Slushie' },
                { id: 'pinaColadaSlushie', name: 'Pina Colada Slushie' }
            ],
            "absolut raspberri": [
                { id: 'raspberryDaisyKilner', name: 'Raspberry Daisy Kilner' },
                { id: 'raspberryDaisyBtl', name: 'Raspberry Daisy BTL' }
            ],
            "blend passionfruit": [
                { id: 'pergolaKilner', name: 'Pergola Punch Batch Kilner' },
                { id: 'pergolaBtl', name: 'Pergola Punch Batch BTL' }
            ],
            "creme de mure": [
                { id: 'raspberryDaisyKilner', name: 'Raspberry Daisy Kilner' },
                { id: 'raspberryDaisyBtl', name: 'Raspberry Daisy BTL' }
            ],
            "funkin passionfruit": [
                { id: 'pureeBtl', name: 'Puree BTL' },
                { id: 'pergolaPunchJuiceBatch', name: 'Pergola Punch Juice Batch' }
            ],
            "pineapple juice": [
                { id: 'pergolaPunchJuiceBatch', name: 'Pergola Punch Juice Batch' }
            ]
        };
        const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
        let currentDay = days[(new Date().getDay() + 6) % 7];

        function main() {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setupEventListeners();
            applyInitialTheme();
            
            onAuthStateChanged(auth, (user) => {
                const loginOverlay = document.getElementById('login-overlay');
                const appContainer = document.getElementById('app');
                if (user) {
                    userId = user.uid;
                    loginOverlay.style.display = 'none';
                    appContainer.style.display = 'block';
                    document.getElementById('loading').style.display = 'none';
                    if (!dataListenersAttached) {
                        setupDataListeners();
                        dataListenersAttached = true;
                    }
                } else {
                    userId = null;
                    dataListenersAttached = false;
                    loginOverlay.style.display = 'flex';
                    appContainer.style.display = 'none';
                }
            });
        }

        function setupDataListeners() {
            onSnapshot(collection(db, "products"), (snapshot) => {
                products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                products.sort((a, b) => (a.order || 0) - (b.order || 0));
                if (!selectedProductId && !selectedRoomId && products.length > 0) {
                    selectedProductId = products[0].id;
                    inputMode = 'byProduct';
                }
                render();
            }, (err) => console.error("Product listener error:", err));
            
            onSnapshot(collection(db, "counts"), (snapshot) => {
                counts = {};
                snapshot.docs.forEach(doc => { counts[doc.id] = doc.data(); });
                render();
            }, (err) => console.error("Counts listener error:", err));
        }

        function render() {
            if (!userId) return;
            const mainContent = document.getElementById('main-content');
            while (mainContent.lastChild && mainContent.lastChild.id !== 'loading') {
                mainContent.removeChild(mainContent.lastChild);
            }
            switch (currentView) {
                case 'input': mainContent.appendChild(document.getElementById('input-view-template').content.cloneNode(true)); renderInputView(); break;
                case 'view': mainContent.appendChild(document.getElementById('view-view-template').content.cloneNode(true)); renderViewView(); break;
                case 'configure': mainContent.appendChild(document.getElementById('configure-view-template').content.cloneNode(true)); renderConfigureView(); break;
            }
            updateNavButtons();
        }

        function renderDaySelector(containerId) {
            const selector = document.getElementById(containerId);
            if (!selector) return;
            selector.innerHTML = '';
            days.forEach(day => {
                selector.add(new Option(day.charAt(0).toUpperCase() + day.slice(1), day));
            });
            selector.value = currentDay;
        }

        function renderInputView() {
            renderDaySelector('day-selector');
            const selectorContainer = document.getElementById('selector-container');
            const container = document.getElementById('product-input-container');
            if (!selectorContainer || !container) return;
            
            document.querySelectorAll('.input-mode-btn').forEach(btn => {
                const isActive = btn.dataset.mode === inputMode;
                btn.classList.toggle('bg-green-600', isActive);
                btn.classList.toggle('text-white', isActive);
                btn.classList.toggle('bg-gray-700', !isActive);
                btn.classList.toggle('text-gray-300', !isActive);
            });

            selectorContainer.innerHTML = '';
            container.innerHTML = '';

            if (inputMode === 'byProduct') {
                selectorContainer.innerHTML = `
                    <label for="product-selector" class="font-semibold w-28">By Product:</label>
                    <select id="product-selector" class="flex-grow p-2 border rounded-md shadow-sm" style="background-color: var(--bg-tertiary); border-color: var(--border-color);"></select>`;
                const productSelector = document.getElementById('product-selector');
                productSelector.innerHTML = '<option value="">Select a product...</option>';
                products.forEach(p => productSelector.add(new Option(p.name, p.id)));
                productSelector.value = selectedProductId;
                if (!selectedProductId) {
                    container.innerHTML = `<p class="text-center p-4 rounded-lg shadow border" style="background-color: var(--bg-secondary); border-color: var(--border-color);">Please select a product.</p>`;
                } else {
                    renderInputByProduct(container);
                }
            } else { // byRoom
                selectorContainer.innerHTML = `
                    <label for="room-selector" class="font-semibold w-28">By Room:</label>
                    <select id="room-selector" class="flex-grow p-2 border rounded-md shadow-sm" style="background-color: var(--bg-tertiary); border-color: var(--border-color);"></select>`;
                const roomSelector = document.getElementById('room-selector');
                roomSelector.innerHTML = '<option value="">Select a room...</option>';
                locations.forEach(l => roomSelector.add(new Option(l.name, l.id)));
                roomSelector.value = selectedRoomId;
                 if (!selectedRoomId) {
                    container.innerHTML = `<p class="text-center p-4 rounded-lg shadow border" style="background-color: var(--bg-secondary); border-color: var(--border-color);">Please select a room.</p>`;
                } else {
                    renderInputByRoom(container);
                }
            }
        }

        function renderInputByProduct(container) {
            const selectedProduct = products.find(p => p.id === selectedProductId);
            const specialInputsForProduct = selectedProduct ? specialProductConfig[selectedProduct.name.toLowerCase()] : null;

            const standardContainer = document.createElement('div');
            standardContainer.className = 'grid grid-cols-1 md:grid-cols-2 gap-6';
            locations.forEach(location => {
                const count = counts[selectedProductId]?.[currentDay]?.[location.id] || 0;
                const locationEl = document.createElement('div');
                locationEl.className = 'rounded-lg shadow p-6 border';
                locationEl.style.backgroundColor = 'var(--bg-secondary)';
                locationEl.style.borderColor = 'var(--border-color)';
                locationEl.innerHTML = `
                    <h3 class="text-lg font-bold mb-4">${location.name}</h3>
                    <div class="flex items-center justify-between">
                        <label for="${location.id}-${selectedProductId}" class="text-sm">Count</label>
                        <input type="number" id="${location.id}-${selectedProductId}" data-product-id="${selectedProductId}" data-location-id="${location.id}" value="${count}" class="count-input w-20 p-1 border rounded-md text-right" style="background-color: var(--bg-tertiary); border-color: var(--border-color);">
                    </div>`;
                standardContainer.appendChild(locationEl);
            });
            container.appendChild(standardContainer);
            
            if (specialInputsForProduct) {
                const specialContainerWrapper = document.createElement('div');
                specialContainerWrapper.className = 'mt-6';
                specialContainerWrapper.innerHTML = `<h3 class="text-lg font-bold mb-4">Batch & Special Inputs</h3>`;
                const specialContainer = document.createElement('div');
                specialContainer.className = 'grid grid-cols-1 md:grid-cols-2 gap-6';
                specialInputsForProduct.forEach(input => {
                    const count = counts[selectedProductId]?.[currentDay]?.specialInputs?.[input.id] || 0;
                    const specialEl = document.createElement('div');
                    specialEl.className = 'rounded-lg shadow p-6 border';
                    specialEl.style.backgroundColor = 'var(--bg-secondary)';
                    specialEl.style.borderColor = 'var(--border-color)';
                    specialEl.innerHTML = `
                        <div class="flex items-center justify-between">
                            <label for="${input.id}-${selectedProductId}" class="text-sm">${input.name}</label>
                            <input type="number" id="${input.id}-${selectedProductId}" data-product-id="${selectedProductId}" data-special-id="${input.id}" value="${count}" class="special-input w-20 p-1 border rounded-md text-right" style="background-color: var(--bg-tertiary); border-color: var(--border-color);">
                        </div>`;
                    specialContainer.appendChild(specialEl);
                });
                specialContainerWrapper.appendChild(specialContainer);
                container.appendChild(specialContainerWrapper);
            }
        }

        function renderInputByRoom(container) {
            const roomName = locations.find(l => l.id === selectedRoomId)?.name || '';
            const roomContainer = document.createElement('div');
            roomContainer.className = 'rounded-lg shadow p-6 border';
            roomContainer.style.backgroundColor = 'var(--bg-secondary)';
            roomContainer.style.borderColor = 'var(--border-color)';
            roomContainer.innerHTML = `<h2 class="text-xl font-bold mb-4">Editing: ${roomName}</h2>`;
            
            const productList = document.createElement('div');
            productList.className = 'space-y-3';

            products.forEach(product => {
                const count = counts[product.id]?.[currentDay]?.[selectedRoomId] || 0;
                const productRow = document.createElement('div');
                productRow.className = 'flex items-center justify-between';
                productRow.innerHTML = `
                    <label for="${selectedRoomId}-${product.id}" class="text-sm">${product.name}</label>
                    <input type="number" id="${selectedRoomId}-${product.id}" data-product-id="${product.id}" data-location-id="${selectedRoomId}" value="${count}" class="count-input w-20 p-1 border rounded-md text-right" style="background-color: var(--bg-tertiary); border-color: var(--border-color);">
                `;
                productList.appendChild(productRow);
            });
            
            roomContainer.appendChild(productList);
            container.appendChild(roomContainer);
        }

        function calculateProductTotal(productId, day) {
            const product = products.find(p => p.id === productId);
            const dayCounts = counts[productId]?.[day] || {};
            
            let total = locations.reduce((sum, loc) => sum + (Number(dayCounts[loc.id]) || 0), 0);
            
            if (product && dayCounts.specialInputs) {
                const specials = dayCounts.specialInputs;
                const productNameLower = product.name.toLowerCase();

                if (productNameLower === "ron santiago 8yo") {
                    const kilnerInput = Number(specials.pergolaKilner) || 0;
                    const btlInput = Number(specials.pergolaBtl) || 0;
                    const strawberryInput = Number(specials.strawberrySlushie) || 0;
                    const pinaInput = Number(specials.pinaColadaSlushie) || 0;

                    total += (kilnerInput * 8400 * (7 / 12)) / 700;
                    total += (btlInput * 700 * (7 / 12)) / 700;
                    total += (strawberryInput * 10000 * (350 / 2350)) / 700;
                    total += (pinaInput * 10000 * (350 / 2350)) / 700;
                } else if (productNameLower === "absolut raspberri" || productNameLower === "creme de mure") {
                    const kilnerInput = Number(specials.raspberryDaisyKilner) || 0;
                    const btlInput = Number(specials.raspberryDaisyBtl) || 0;
                    
                    total += (kilnerInput * 8400 * (7 / 12)) / 700;
                    total += (btlInput * 700 * (7 / 12)) / 700;
                } else if (productNameLower === "blend passionfruit") {
                    const kilnerInput = Number(specials.pergolaKilner) || 0;
                    const btlInput = Number(specials.pergolaBtl) || 0;

                    total += (kilnerInput * 8400 * (5 / 12)) / 700;
                    total += (btlInput * 700 * (5 / 12)) / 700;
                } else if (productNameLower === "funkin passionfruit") {
                    const pureeInput = Number(specials.pureeBtl) || 0;
                    const juiceBatchInput = Number(specials.pergolaPunchJuiceBatch) || 0;
                    
                    total += pureeInput * (7/10);
                    total += juiceBatchInput * 10 * (25/85);
                } else if (productNameLower === "pineapple juice") {
                    const juiceBatchInput = Number(specials.pergolaPunchJuiceBatch) || 0;
                    
                    total += juiceBatchInput * 10 * (35/85);
                }
            }
            
            return total;
        }

        function renderViewView() {
            const controls = document.getElementById('view-controls');
            const content = document.getElementById('view-content-container');
            if (!controls || !content) return;
            controls.innerHTML = '';
            content.innerHTML = '';
            
            const toggleBtn = document.createElement('button');
            toggleBtn.id = 'toggle-view-mode-btn';
            toggleBtn.className = 'text-white px-4 py-2 rounded-md shadow';
            toggleBtn.style.backgroundColor = 'var(--accent-color)';

            if (viewPageMode === 'daily') {
                toggleBtn.textContent = 'Show Weekly Summary';
                const daySelectorContainer = document.createElement('div');
                daySelectorContainer.className = 'flex items-center space-x-2';
                daySelectorContainer.innerHTML = `<label for="day-selector" class="font-semibold">Day:</label><select id="day-selector" class="p-2 border rounded-md" style="background-color: var(--bg-tertiary); border-color: var(--border-color);"></select>`;
                controls.appendChild(daySelectorContainer);
                renderDaySelector('day-selector');
                renderDailyTotals(content);
            } else {
                toggleBtn.textContent = 'Show Daily View';
                const title = document.createElement('h2');
                title.className = 'text-xl font-bold';
                title.textContent = 'Weekly Summary';
                controls.appendChild(title);
                renderWeeklySummary(content);
            }
            controls.appendChild(toggleBtn);
        }

        function renderDailyTotals(container) {
            container.innerHTML = '';
            if (products.length === 0) return;
            const list = document.createElement('ul');
            list.className = 'space-y-2';
            products.forEach((product, index) => {
                const total = calculateProductTotal(product.id, currentDay);
                const item = document.createElement('li');
                item.className = 'flex justify-between items-center p-2 rounded-md';
                if(index % 2 !== 0) {
                    item.style.backgroundColor = 'var(--bg-tertiary)';
                }
                item.innerHTML = `<span>${product.name}</span><span class="font-bold text-lg">${total.toFixed(2)}</span>`;
                list.appendChild(item);
            });
            container.appendChild(list);
        }

        function renderWeeklySummary(container) {
            container.innerHTML = '';
            if (products.length === 0) return;
            const table = document.createElement('table');
            table.className = 'summary-table';
            const headers = ['Product', 'Opening', ...days];
            const thead = table.createTHead();
            const headerRow = thead.insertRow();
            headers.forEach(headerText => {
                const th = document.createElement('th');
                const isCurrentDay = headerText.toLowerCase() === currentDay;
                if (isCurrentDay) {
                    th.style.backgroundColor = 'var(--table-highlight)';
                }
                th.textContent = headerText.length > 3 ? headerText.slice(0, 3).toUpperCase() : headerText;
                headerRow.appendChild(th);
            });

            const tbody = table.createTBody();
            products.forEach(product => {
                const row = tbody.insertRow();
                row.insertCell().textContent = product.name;
                row.insertCell().textContent = product.openingStock || 0;
                days.forEach(day => {
                    const total = calculateProductTotal(product.id, day);
                    const cell = row.insertCell();
                    cell.textContent = total.toFixed(2);
                    if (day === currentDay) {
                        cell.style.backgroundColor = 'var(--table-highlight-faint)';
                    }
                });
            });
            container.appendChild(table);
        }

        function renderConfigureView() {
            const list = document.getElementById('product-list');
            if (!list) return;
            list.innerHTML = '';
            if (products.length === 0) {
                list.innerHTML = `<li>No products yet.</li>`;
            } else {
                products.forEach((product, index) => {
                    const item = document.createElement('li');
                    item.className = 'flex items-center p-2 rounded-md gap-2';
                    if(index % 2 !== 0) {
                        item.style.backgroundColor = 'var(--bg-tertiary)';
                    }
                    item.draggable = true;
                    item.dataset.id = product.id;
                    item.innerHTML = `
                        <div class="handle pr-2 text-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-grip-vertical" viewBox="0 0 16 16"><path d="M7 2a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM7 5a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM7 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-3 3a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-3 3a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/></svg>
                        </div>
                        <div class="flex-grow">${product.name}</div>
                        <div class="flex items-center gap-2">
                            <label for="os-${product.id}" class="text-sm font-medium">Opening:</label>
                            <input type="number" id="os-${product.id}" data-id="${product.id}" value="${product.openingStock || 0}" class="opening-stock-input w-20 p-1 border rounded-md text-right" style="background-color: var(--bg-tertiary); border-color: var(--border-color);">
                        </div>
                        <button data-id="${product.id}" class="delete-product-btn text-red-500 hover:text-red-400 font-semibold text-sm">DELETE</button>
                    `;
                    list.appendChild(item);
                });
            }
        }

        function setupEventListeners() {
            document.body.addEventListener('click', async (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                if (target.id === 'login-submit') {
                    const emailInput = document.getElementById('email-input');
                    const passwordInput = document.getElementById('password-input');
                    const loginError = document.getElementById('login-error');
                    loginError.textContent = '';
                    try {
                        await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
                    } catch (error) {
                        loginError.textContent = 'Login failed. Please check credentials.';
                    }
                }
                if (target.id === 'logout-button') await signOut(auth);
                if (target.id === 'theme-toggle') toggleTheme();
                if (target.id === 'toggle-view-mode-btn') handleToggleViewMode();
                if (target.classList.contains('delete-product-btn')) handleDeleteProduct(target);
                if (target.id === 'add-product-btn') handleAddProduct();
                if (target.classList.contains('nav-button')) handleNavClick(target);
                if (target.classList.contains('input-mode-btn')) handleInputModeChange(target);
            });

            document.body.addEventListener('change', (e) => {
                if (e.target.id === 'day-selector') handleDayChange(e);
                if (e.target.id === 'product-selector') handleProductSelect(e);
                if (e.target.id === 'room-selector') handleRoomSelect(e);
            });

            document.body.addEventListener('keyup', (e) => {
                if (e.target.id === 'new-product-name' && e.key === 'Enter') handleAddProduct();
                if (e.target.id === 'password-input' && e.key === 'Enter') document.getElementById('login-submit').click();
            });

            document.body.addEventListener('input', debounce((e) => {
                if (e.target.classList.contains('count-input')) handleCountChange(e);
                if (e.target.classList.contains('special-input')) handleSpecialInputChange(e);
                if (e.target.classList.contains('opening-stock-input')) handleOpeningStockChange(e);
            }, 500));
            
            document.body.addEventListener('focusin', (e) => {
                if (e.target.tagName === 'INPUT' && e.target.type === 'number') {
                    e.target.select();
                }
            });

            let draggedItem = null;
            document.body.addEventListener('dragstart', (e) => {
                if (e.target.tagName === 'LI') {
                    draggedItem = e.target;
                    setTimeout(() => e.target.classList.add('dragging'), 0);
                }
            });
            document.body.addEventListener('dragend', (e) => {
                if (draggedItem) {
                    draggedItem.classList.remove('dragging');
                    draggedItem = null;
                }
            });
            document.body.addEventListener('dragover', (e) => {
                e.preventDefault();
                const list = document.getElementById('product-list');
                const afterElement = getDragAfterElement(list, e.clientY);
                const currentDragged = document.querySelector('.dragging');
                if (afterElement == null) {
                    list.appendChild(currentDragged);
                } else {
                    list.insertBefore(currentDragged, afterElement);
                }
            });
            document.body.addEventListener('drop', (e) => {
                e.preventDefault();
                handleDrop();
            });
        }
        
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('li:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        async function handleDrop() {
            const list = document.getElementById('product-list');
            if (!list) return;
            const newOrderedIds = [...list.querySelectorAll('li')].map(li => li.dataset.id);
            const batch = writeBatch(db);
            newOrderedIds.forEach((id, index) => {
                const docRef = doc(db, 'products', id);
                batch.update(docRef, { order: index + 1 });
            });
            await batch.commit();
        }
        
        function handleDayChange(e) { currentDay = e.target.value; render(); }
        function handleProductSelect(e) { 
            selectedProductId = e.target.value;
            render(); 
        }
        function handleRoomSelect(e) {
            selectedRoomId = e.target.value;
            render();
        }
        function handleInputModeChange(target) {
            inputMode = target.dataset.mode;
            if (inputMode === 'byProduct') {
                selectedRoomId = null;
                if (!selectedProductId && products.length > 0) selectedProductId = products[0].id;
            } else { // byRoom
                selectedProductId = null;
                if (!selectedRoomId && locations.length > 0) selectedRoomId = locations[0].id;
            }
            render();
        }
        function handleToggleViewMode() { viewPageMode = viewPageMode === 'daily' ? 'weekly' : 'daily'; render(); }
        function handleNavClick(target) { 
            if (target.dataset.view === 'input') {
                currentDay = days[(new Date().getDay() + 6) % 7];
            }
            currentView = target.dataset.view; 
            render(); 
        }

        async function handleAddProduct() {
            const input = document.getElementById('new-product-name');
            const productName = input.value.trim();
            if (productName) {
                const maxOrder = products.reduce((max, p) => Math.max(max, p.order || 0), 0);
                await addDoc(collection(db, 'products'), { 
                    name: productName, 
                    openingStock: 0,
                    order: products.length > 0 ? maxOrder + 1 : 1
                });
                input.value = '';
            }
        }

        async function handleDeleteProduct(target) {
            const productId = target.dataset.id;
            const batch = writeBatch(db);
            batch.delete(doc(db, 'products', productId));
            batch.delete(doc(db, 'counts', productId));
            await batch.commit();
        }

        async function handleCountChange(e) {
            const { productId, locationId } = e.target.dataset;
            const value = e.target.value;
            const countRef = doc(db, 'counts', productId);
            await setDoc(countRef, { [currentDay]: { [locationId]: Number(value) || 0 } }, { merge: true });
        }

        async function handleSpecialInputChange(e) {
            const { productId, specialId } = e.target.dataset;
            const value = e.target.value;
            const countRef = doc(db, 'counts', productId);
            await setDoc(countRef, { [currentDay]: { specialInputs: { [specialId]: Number(value) || 0 } } }, { merge: true });
        }

        async function handleOpeningStockChange(e) {
            const productId = e.target.dataset.id;
            const value = e.target.value;
            const productRef = doc(db, 'products', productId);
            await updateDoc(productRef, { openingStock: Number(value) || 0 });
        }

        function updateNavButtons() {
            document.querySelectorAll('.nav-button').forEach(button => {
                const isSelected = button.dataset.view === currentView;
                button.classList.toggle('bg-green-600', isSelected);
                button.classList.toggle('text-white', isSelected);
                button.classList.toggle('bg-gray-700', !isSelected);
                button.classList.toggle('text-gray-300', !isSelected);
            });
        }
        
        function toggleTheme() {
            const currentTheme = document.body.dataset.theme || 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.body.dataset.theme = newTheme;
            localStorage.setItem('theme', newTheme);
            updateThemeIcons(newTheme);
        }

        function updateThemeIcons(theme) {
            document.getElementById('theme-icon-dark').classList.toggle('hidden', theme === 'light');
            document.getElementById('theme-icon-light').classList.toggle('hidden', theme === 'dark');
        }

        function applyInitialTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.body.dataset.theme = savedTheme;
            updateThemeIcons(savedTheme);
        }

        function debounce(func, delay) {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        main();
    </script>
</body>
</html>
